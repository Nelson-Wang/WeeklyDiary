“小白”成长记—基础知识学习总结之VLAN
日期：2019-06-17 10:02浏览：101评论：0
基础知识学习总结之VLAN

1.      背景

广播风暴：传统的局域网使用的是HUB（集线器），HUB只有一根总线，属于一个冲突域，任何一台主机发出的报文会被同一冲突域的其它所有机器接收。后来使用switch（二层交换机）代替HUB，冲突域缩小到每个端口，网络发送单播报文的效率得到了提升，但网络中所有端口仍然属于同一个广播域，switch在传递广播报文的时候仍然要将广播报文复制多份并发送到网络的各个角落。广播报文越来越多，占用的网络资源就越来越大，严重影响网络性能，这就是所谓的广播风暴。

Switch受工作原理的限制，无法解决。那如何解决广播风暴呢？把大的广播域划分为几个小的广播域。首先用到的是通过路由器对LAN进行划分，使用路由器代替中心节点交换机，使得广播报文发送范围大大减小。但这种方法有一个弊端就是在网络上层段将网络隔离，规划复杂，组网方式不灵活，且管理维护难度增加。为此，引入虚拟局域网（VLAN）来解决上述问题。

2.      VLAN概念及划分原则

2.1 VLAN概念

VLAN（Virtual Local Area Network）即虚拟局域网，是一种将一个物理上实际的局域网按一定逻辑原则划分成多个小的网段从而实现虚拟工作组的技术。与传统的LAN相比，其主要优势有：组网灵活，配置管理简单，减少移动和改变的代价，降低维护成本；隔离广播域，提高带宽利用率；增强通讯的保密性、具有良好的扩展性。

2.2 划分原则

VLAN划分原则：

（1）基于端口划分：根据交换机的端口划分VLAN，端口可以不连续且可以跨越多个交换机划分，是目前最常用的VLAN划分原则。优点是定义VLAN成员时非常简单，只需要将所有端口指定一下。缺点是若某VLAN用户更换了端口，则需要重新定义。

（2）基于MAC地址划分：根据每个主机的MAC地址划分VLAN，也可称之为基于用户的VLAN。优点是当主机物理移动（从一个交换机到另一个交换机）时不需要重新配置。缺点是初始化时所有的主机都必须进行配置，交换机的效率也可能因存在多个VLAN组的成员而降低。

（3）基于协议划分：根据二层数据帧中协议字段进行VLAN划分。若一个局域网内有多种协议运行的时候，可采用这种划分原则。但实际应用中很少。

（4）基于子网划分：根据报文中的IP地址划分VLAN，同一个IP子网的所有用户属于同一个VLAN。优点是用户可在网络内部自由移动而不用重新配置。缺点是效率降低，且由于同一个端口可能存在多个VLAN组成员，对广播报文无法有效抑制。

2.3 VLAN的类型

VLAN共有四种不同类型，具体如下表2.1：

表2.1 VLAN类型

VLAN类型

特点

Mux

一个MUX VLAN可包含多个上行端口，但只包含一个业务虚端口，VLAN间的业务虚端口相互隔离。VLAN与接入用户存在一对一的映射关系。

Smart

一个Smart VLAN中可包含多个上行端口和多个业务虚端口，且同一个Smart VLAN包含的业务虚端口相互隔离。VLAN间的业务虚端口也相互隔离。

Standard

一个Standard VLAN包含多个上行端口，VLAN中的以太网端口可相互通信，VLAN间的以太网端口相互隔离。

Super

它是基于三层的VLAN。一个Super VLAN中可包含多个Sub VLAN。Sub VLAN的类型可以为：Smart VLAN、MUX VLAN。通过ARP proxy可实现Sub VLAN的互相通信。各个Sub VLAN统一通过Super VLAN的三层接口实现三层转发业务。

3.      VLAN标准协议及帧格式

IEEE802.1Q协议是VLAN 的正式标准，主要定义了以下内容：VLAN的架构、VLAN中所提供的服务、VLAN实施中涉及的协议和算法。此外还制定了诸如帧发送校验、回路检测，对QOS参数的支持以及对网管系统的支持等方面的标准。

3.1 VLAN的帧格式

IEEE802.1Q所附加的VLAN识别信息，位于数据帧中“发送源MAC地址”和“类型”之间。具体识别信息包括2字节的TPID（标签协议标识）和2字节的TCI（标签控制信息）。如下图3.1及下表3.1所示：



TPID（tag protocol identifier）包含了一个固定的值0x8100。

TCI包含帧的控制信息，主要包括以下几种元素：

Priority：表明帧的优先级，取0~7，值越大表明优先级越高。

CFI（canonical format indicator）：表明MAC地址是否为规范格式，0表示规范格式，1表示非规范格式。

VLAN ID（VLAN identified）：指明VLAN的ID，取值范围0~4095。

4.      VLAN链路及端口类型

4.1 链路类型

VLAN链路共有两种类型，如下所示：

Access link（接入链路）：用于连接主机和交换机的链路。属于某一特定的端口，这个端口只属于一个VLAN，不关心VLAN的成员都有谁。不同的VLAN之间不能通信，若要通信需要路由器或路由模块的协助。接收和发送的帧都是未标记帧（untagged frame）。

Trunk link（干道链路）：用于交换机与路由器以及交换机之间互联的链路。可能属于多个VLAN。所有传输的帧都是标记帧（tagged frame）。

4.2 VLAN的端口类型

首先了解PVID（Port Base VLAN ID/Port Default VLAN ID），可理解为端口VLAN ID（基于trunk端口）或端口缺省虚拟局域网ID（基于access端口）。不同的端口类型均有且只有一个PVID。华为交换机缺省VLAN被称为“Pvid Vlan”，对于思科交换机缺省VLAN被称为“Native Vlan”。

（1）Access端口：指交换机上用来连接用户主机的端口，只能属于一个VLAN，因此不用单独设置PVID。

（2）Trunk端口：指用于交换机之间连接的端口，可以允许多个VLAN通过，可接收和发送多个VLAN的报文。

（3）Hybrid端口：既可用于交换机之间连接，也可用于连接用户主机，可以允许多个VLAN通过，可接收和发送多个VLAN的报文。

（4）Qinq（802.1Q-in-802.1Q）端口：交换机上和其他交换机连接的，并且能够处理携带双层Tag标记的VLAN帧的端口。

各个端口数据处理过程如下表：

表4.1 各端口数据处理过程

         端口类型

数据类型

Access

Trunk

Hybrid

Qinq

In

Tagged

等于PVID，允许通过，其他丢弃

VLAN列表内或等于PVID，允许通过

VLAN列表内或等于PVID，允许通过

打上PVID，允许通过

Untagged

打上PVID，通过

打上PVID，通过

打上PVID，通过

打上PVID，通过

Out

Tagged

与PVID一致，剥离tag通过

等于PVID，剥离tag通过，VLAN列表内直接通过

在允许列表里，可以通过，是否带tag可设置

与PVID一致，剥离tag通过

Untagged

不允许通过

不允许通过

不允许通过

不允许通过

（这里不单独介绍VLAN实验配置过程。后续会对GPON业务流配置过程进行详细说明，其中将包括VLAN部分的配置过程介绍及常用命令介绍。）
